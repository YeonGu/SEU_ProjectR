---
title: IIC协议
lang: zh-CN
---


#   连接世界的总线

在```实验二 UART串口通讯```当中，你已经了解了通讯协议相关的知识，并且完成了UART的输入输出功能。

事实上，通讯协议是多种多样的，使用哪一种大多数时候取决于单片机要和什么样的外部设备进行沟通——如果你买到的模块使用的不是UART协议而是其他协议，你将会不可避免地使用模块所要求的其他协议进行通讯。

这一章将要介绍另外一种通讯协议——```I²C(Inter-Integrated Circuit)```协议。
::: tip 以前我没得选，但现在……
假如你买的是别人生产的模块，自然需要使用厂家指定的通讯协议。

但是在将来，你可能会遇到 ```我有两个单片机芯片，他们之间该采用哪种协议进行通讯？``` 这样的问题。亦或者，你会使用自己的模块。

现在，通讯协议是有得选的，该选哪一种？链接里的文章提供了一些不同通讯协议的对比，还有一些专业人士的意见。

[How do you choose between SPI, I2C, and UART for embedded communication?](https://www.linkedin.com/advice/0/how-do-you-choose-between-spi-i2c-uart-embedded)
:::

## IIC协议简介
> I²C（Inter-Integrated Circuit）字面上的意思是集成电路之间，它其实是I²C Bus简称，所以中文应该叫集成电路总线，它是一种串行通信总线，使用多主从架构，由飞利浦公司在1980年代为了让主板、嵌入式系统或手机用以连接低速周边设备而发展。I²C的正确读法为“I平方C”（"I-squared-C"），而“I二C”（"I-two-C"）则是另一种错误但被广泛使用的读法。自2006年10月1日起，使用I²C协议已经不需要支付专利费，但制造商仍然需要付费以获取I²C从属设备地址。
>
>来源：维基百科

多说无益，查看[这个视频](https://www.bilibili.com/video/BV1dg4y1H773/)，你应该能够对I²C协议有一定的理解。

所以这就是I²C了：和UART一样的两根线，一根上面是不断震荡的时钟信号，而另外一根用来传输实打实的数据。由于I²C里面还加入了```设备地址```这样的概念，你可以在这两根线上面连上至多112个从机设备，只需要两根线就可以和所有这些设备进行通讯。

::: tip 为什么是112个？
I²C的设备地址是7位的，这意味着理论上你可以连上2^7=128个设备，但是I²C协议当中有一些地址作为特殊地址被保留下来了，其中一些是有特殊作用的，查看I²C协议官网上的[这个页面](https://www.i2c-bus.org/addressing/)可以获得它们的一些信息。
:::

::: tip
如果你还想深入了解I²C协议，可以看看[这份](/IIC/sbaa565.pdf)由德州仪器公司给出的。
:::

## 把字刻在石头上
程序运行的时候，所有变量都是存在```随机存取存储器(RAM)```当中的，而在当今的技术中，RAM是由易失性元件组成的。对于单片机而言，RAM被集成在芯片内部（这也是单片机之所以叫做单片机的原因——个计算机系统都集成到一个芯片上）这意味着一旦你将单片机的电源断电，RAM当中的存储的变量信息都会失去。

事实上，STM32本身已经提供了数据永久保存的方式——你可以把线拔下来然后再插上去，会发现之前烧录过的代码依然可以正常运行，而不需要重新烧录。这意味着烧录在芯片里的代码数据并不会在断电之后消失。这是因为程序被保存在了```闪存(Flash)```当中。你可以在芯片的数据手册里面找到Flash存储器的相关信息。HAL库也提供了相应的函数供你访问Flash存储器。

但是为了学习I²C协议，在这一节实验当中，我们将会尝试使用外置的```EEPROM```模块来保存一些希望在断电之后仍然保留的数据。它和单片机之间采用```I²C```协议进行通讯。

::: warning 必做题：查看EEPROM模块的数据手册
从这里开始，讲义将不会完整提供所有你需要RTFM的手册——我们也不知道你是在哪里买到了什么样型号的模块。你需要自己去想办法找到他们：或许是在制造商的网站上根据型号查找，或者询问售卖这个模块的电商平台的商家。你需要想办法自己从当中获取你需要的信息。
:::

::: danger 这太难了 我不会 TAT
**没有人会一直向你提供帮助。** 在竞赛场上，或者是你将来的电子工程师生涯当中，你终将会面临需要**独立解决问题**的时候。这是一个真正的工程师应当具有的美好品质，这也是这份讲义想要着重强调的能力。如果你觉得阅读文档还是太难了，这说明你并没有在前面的章节当中得到应有的训练。

**从现在起不要偷懒了**。回到之前的讲义当中，查看那些你遗忘的要求查看文档的内容。锻炼你使用Ctrl+F和网页搜索进行RTFM的能力，你最后总能看懂世界上所有的文档。

“我们终将知道，我们必须知道。”
:::
### EEPROM模块介绍
接下来以```AT24C02```这个模块为例，对EEPROM模块进行介绍。在前面那个讲解I²C协议的视频当中，你已经见过它的面了，不过，我们将从数据手册当中再次认识它的使用方式。

首先进行STFW找到它的数据手册：[AT24C01A.PDF](/AT24C01A.PDF)

我们想知道的是如何对存储器进行读写，存储器的编址方式和读写的指令格式都是我们所关心的，所以直接在目录当中找到```Device Addressing```，```Write Operations```和```Read Operations```两节开始阅读。

Device Addressing 一节给出了这样的一张表格：

![Figure 7](/IIC/DeviceAddress.png)

它对 I²C 协议当中的设备地址这个部分做出了一些要求。首先，最高四位是```1010```，这对于所有```EEPROM```设备来说都是一样的。

其次是低四位，可以看到，最低位是一位读取/写入选择信号，而前三位则根据模块容量的大小而有所不同。对于小容量的1K、2K模块，这三位全部被用作设备选择位，用来在多片EEPROM当中进行选择，以便同时使用多个模块。而对于更大的容量，I²C协议的8位寻址空间不够用了（对于4KB的存储器而言，需要 log2(4096/8)=9位 地址进行编码），所以占用了设备地址来保证对于整个大空间的访问。

然后看```Write Operations```这一节给出的时序图：

![Figure 8](/IIC/Write.png)

和之前视频当中所讲的大体相同，只不过给出了 ```Page Write``` 这种可以一次性写更多数据的方式。

读取这边则是多了顺序写入和随机写入两种方式。自己查看文档，理解他们的构造。

### STM32上I²C协议的使用
查看视频：[IIC通信与温湿度传感器AHT20(DHT20)](https://www.bilibili.com/video/BV1QN411D7ak)，了解HAL库中I²C相关函数的使用。

::: tip 哪些细节被隐藏了？
视频当中提到，在上一节```EEPROM模块介绍```当中提到的一些协议当中的细节被HAL库隐藏起来了，不需要你去关心，请你仔细想想是哪些地方。
:::


::: tip RTFM
现在已经是进阶部分了，你可以尝试着自己去探索HAL库的内容。

你可以在

```Path
C:\Users\<你的用户名>\STM32Cube\Repository\STM32Cube_FW_F4_Vx.xx.xx\Drivers\STM32F4xx_HAL_Driver
```

这个路径下面找到几个`.chm`文件，他们是HAL库的文档，打开对应芯片型号的文档。进行一些搜索，你应该可以找到视频里介绍的I²C相关函数的参考文档内容。

:::

::: warning 必做题：为指令协议添加读写EEPROM相关的指令
你已经在[基础篇最终话: 随心操控的小灯](5EX1)当中实现了一个简单的指令协议，现在为它添加两条新的指令，他们的作用是对EEPROM的指定地址进行读写一个字节的数据的操作：
```TEXT
\ROMSAVE 0x00 0xfe;
         |    |
         |    +--- 要写入的内容
         +-------- 要写入的地址

\ROMLOAD 0x00;
         |
         +-------- 要读取的地址
```

其中，```\ROMLOAD```指令在读取指定地址的数据之后，以这样的格式向UART串口以16进制形式打印地址和读取到的值：
```TEXT
[ROMLOAD] Byte at 0x00: 0xfe
```
你可能要参照视频需要对项目进行一些配置，来启用I²C的功能。

你可以使用```sscanf()```函数来对指令后面的参数进行提取。

什么？你问我怎么用？STFW以获取最佳答案。
:::

## 有屏幕的地方就有……
敬请期待
## 必做 & 验收内容 

修改历史
--------

:::info 修改历史
2024/3 完成EEPROM部分编写. (陈昱衡)
:::